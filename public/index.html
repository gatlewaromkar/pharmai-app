<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmAI - Intelligent Pharmacy Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loader {
            border-top-color: #667eea;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ===== FINAL UI POLISH ===== */
        body {
            background:
                radial-gradient(circle at 10% 20%, rgba(102, 126, 234, .15), transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(118, 75, 162, .15), transparent 40%),
                #f8fafc;
        }

        .glass-effect {
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, .05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, .12);
        }

        table tr:hover {
            background: #f9fafb
        }

        .badge-safe {
            background: #ecfdf5;
            color: #047857
        }

        .badge-warn {
            background: #fffbeb;
            color: #92400e
        }

        .badge-risk {
            background: #fef2f2;
            color: #991b1b
        }

        button:hover {
            transform: translateY(-1px)
        }

        .drug-safe {
            background: #ecfdf5;
            color: #047857
        }

        .drug-danger {
            background: #fef2f2;
            color: #991b1b
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white fixed w-full top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-pills text-3xl"></i>
                    <h1 class="text-2xl font-bold">PharmAI</h1>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <a href="#dashboard" class="hover:text-purple-200 transition">Dashboard</a>
                    <a href="#orders" class="hover:text-purple-200 transition">Orders</a>
                    <a href="#prescriptions" class="hover:text-purple-200 transition">Prescriptions</a>
                    <a href="#inventory" class="hover:text-purple-200 transition">Inventory</a>
                    <a href="#ai-assistant" class="hover:text-purple-200 transition">AI Assistant</a>
                </nav>
                <button class="md:hidden" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
        <div class="bg-white w-64 h-full p-6 slide-in">
            <button onclick="toggleMobileMenu()" class="mb-6"><i class="fas fa-times text-2xl"></i></button>
            <nav class="flex flex-col space-y-4">
                <a href="#dashboard" class="text-lg hover:text-purple-600">Dashboard</a>
                <a href="#orders" class="text-lg hover:text-purple-600">Orders</a>
                <a href="#prescriptions" class="text-lg hover:text-purple-600">Prescriptions</a>
                <a href="#inventory" class="text-lg hover:text-purple-600">Inventory</a>
                <a href="#ai-assistant" class="text-lg hover:text-purple-600">AI Assistant</a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-24 pb-12">
        <!-- Hero Section -->
        <section class="mb-12 text-center">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">AI-Powered Pharmacy Management</h2>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">Revolutionizing pharmaceutical care with intelligent
                automation, reducing workload while enhancing patient safety and satisfaction</p>
        </section>

        <!-- Stats Overview -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
            <div class="glass-effect rounded-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-users text-3xl text-purple-600"></i>
                    <span class="text-green-500 text-sm font-semibold">+12%</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800" id="statPatientsDisplay">0</h3>
                <p class="text-gray-600">Active Patients</p>
            </div>

            <div class="glass-effect rounded-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-shopping-cart text-3xl text-blue-600"></i>
                    <span class="text-green-500 text-sm font-semibold">+8%</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800" id="statOrdersDisplay">0</h3>
                <p class="text-gray-600">Today's Orders</p>
            </div>
            <div class="glass-effect rounded-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-prescription text-3xl text-green-600"></i>
                    <span class="text-green-500 text-sm font-semibold">100%</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">98</h3>
                <p class="text-gray-600">Verified Prescriptions</p>
            </div>
            <div class="glass-effect rounded-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-robot text-3xl text-red-600"></i>
                    <span class="text-green-500 text-sm font-semibold pulse-animation">Active</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">87%</h3>
                <p class="text-gray-600">AI Automation Rate</p>
            </div>
            <div class="glass-effect rounded-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <i class="fas fa-rupee-sign text-3xl text-green-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">
                    ‚Çπ<span id="todaySales">0</span>
                </h3>
                <p class="text-gray-600">Today's Sales</p>
            </div>

        </section>

        <!-- Order Management Section -->
        <section id="orders" class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Real-Time Order Management</h3>
            <div class="glass-effect rounded-lg p-6">
                <div class="flex flex-wrap gap-4 mb-6">
                    <button onclick="filterOrders('all')"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">All
                        Orders</button>
                    <button onclick="filterOrders('pending')"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Pending</button>
                    <button onclick="filterOrders('processing')"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Processing</button>
                    <button onclick="filterOrders('delivered')"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Delivered</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Order ID</th>
                                <th class="text-left py-3 px-4">Patient</th>
                                <th class="text-left py-3 px-4">Medicine</th>
                                <th class="text-left py-3 px-4">Status</th>
                                <th class="text-left py-3 px-4">Delivery</th>
                                <th class="text-left py-3 px-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">#ORD-001</td>
                                <td class="py-3 px-4">John Smith</td>
                                <td class="py-3 px-4">Metformin 500mg</td>
                                <td class="py-3 px-4"><span
                                        class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">Processing</span>
                                </td>
                                <td class="py-3 px-4">Today, 3:00 PM</td>
                                <td class="py-3 px-4"><button onclick="trackOrder('ORD-001')"
                                        class="text-purple-600 hover:text-purple-800"><i
                                            class="fas fa-map-marker-alt"></i> Track</button></td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">#ORD-002</td>
                                <td class="py-3 px-4">Sarah Johnson</td>
                                <td class="py-3 px-4">Lisinopril 10mg</td>
                                <td class="py-3 px-4"><span
                                        class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm">Delivered</span>
                                </td>
                                <td class="py-3 px-4">Yesterday</td>
                                <td class="py-3 px-4"><button class="text-gray-400"><i class="fas fa-check"></i>
                                        Complete</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- AI Prescription Verification -->
        <section id="prescriptions" class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">AI Prescription Verification</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-effect rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4">Upload Prescription</h4>
                    <div
                        class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-4">Drag & drop prescription here or click to browse</p>
                        <input type="file" class="hidden" id="prescriptionUpload" onchange="verifyPrescription()">
                        <button onclick="document.getElementById('prescriptionUpload').click()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Select File
                        </button>
                    </div>
                    <div id="verificationResult" class="mt-4 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-green-800"><i class="fas fa-check-circle"></i> Prescription verified by AI
                            </p>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4">Recent Verifications</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file-medical text-green-500"></i>
                                <div>
                                    <p class="font-medium">Dr. Williams - Rx#4521</p>
                                    <p class="text-sm text-gray-600">Verified 2 min ago</p>
                                </div>
                            </div>
                            <span class="text-green-500"><i class="fas fa-check"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Inventory & Stock Prediction -->
        <section id="inventory" class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">AI-Powered Inventory Management</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 glass-effect rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4">Stock Prediction Analysis</h4>
                    <canvas id="stockChart"></canvas>
                </div>
                <div class="glass-effect rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4 text-orange-600">
                        <i class="fas fa-hourglass-half mr-2"></i> Expiry Intelligence
                    </h4>
                    <div class="space-y-3" id="expiryAlertsList">
                        <div class="text-center py-4 text-gray-500 text-sm">Scanning stock...</div>
                    </div>
                </div>
                <div class="glass-effect rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4 text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i> Low Stock Alerts
                    </h4>
                    <div class="space-y-3" id="lowStockAlertsList"></div>
                </div>
            </div>

            <div class="glass-effect p-6 mt-6">
                <h4 class="text-lg font-semibold mb-4">üì¶ Medicine Inventory (Expiry Aware)</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">Medicine</th>
                                <th>Batch</th>
                                <th>Stock</th>
                                <th>Expiry</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Billing System -->
        <section id="billing" class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">üßæ Billing & Sales</h3>
            <div class="glass-effect p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-1">Patient Name</label>
                    <input type="text" id="billPatient" class="border rounded px-4 py-2 w-full md:w-1/2"
                        placeholder="Enter Patient Name">
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    <select id="billMedicineSelect" class="border rounded px-4 py-2 w-full"></select>
                    <input id="billQty" type="number" class="border rounded px-4 py-2" placeholder="Qty">
                    <button onclick="addToBill()" class="bg-purple-600 text-white rounded px-4 py-2">Add</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Medicine</th>
                                <th class="p-2">Price</th>
                                <th class="p-2">Qty</th>
                                <th class="p-2">Total</th>
                            </tr>
                        </thead>
                        <tbody id="billTable"></tbody>
                    </table>
                </div>
                <div class="grid md:grid-cols-3 gap-4 text-sm">
                    <div>Subtotal: ‚Çπ<span id="subTotal">0</span></div>
                    <div>GST (5%): ‚Çπ<span id="gstAmount">0</span></div>
                    <div class="font-semibold">Grand Total: ‚Çπ<span id="grandTotal">0</span></div>
                </div>
                <button onclick="finalizeBill()" class="bg-green-600 text-white px-6 py-2 rounded">Finalize
                    Bill</button>
            </div>
        </section>

        <!-- Patient History -->
        <section id="history" class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">üßë‚Äç‚öïÔ∏è Patient Medication History</h3>
            <div class="mb-6">
                <input type="text" id="patientSelect" class="border rounded px-4 py-2 w-full md:w-1/2"
                    placeholder="Filter by patient name..." oninput="fetchHistory()">
            </div>
            <div id="historyList" class="glass-effect p-6 space-y-4">
                <p class="text-gray-500 text-sm">Loading history...</p>
            </div>
        </section>

        <!-- Drug Interaction Checker -->
        <section class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Drug Interaction Checker</h3>
            <div class="glass-effect p-6">
                <select id="medicineSelect" class="border rounded px-4 py-2 w-full md:w-1/2 mb-4">
                    <option value="">-- Select Medicine for Details --</option>
                </select>
                <div class="grid md:grid-cols-3 gap-4">
                    <input id="drug1" class="border rounded px-4 py-2" placeholder="Medicine 1">
                    <input id="drug2" class="border rounded px-4 py-2" placeholder="Medicine 2">
                    <button onclick="checkDrugInteraction()" class="bg-red-600 text-white px-4 py-2 rounded">Check
                        Interaction</button>
                </div>
                <!-- Medicine Details Panel -->
                <div id="medicinePanel"
                    class="hidden mt-6 p-6 bg-purple-50 rounded-lg border border-purple-100 slide-in">
                    <h4 class="font-bold text-purple-900 mb-3 flex items-center"><i class="fas fa-info-circle mr-2"></i>
                        Clinical Insights</h4>
                    <div class="space-y-2 text-sm text-purple-800">
                        <p id="medPurpose"></p>
                        <p id="medUsage"></p>
                        <p id="medWarning" class="text-red-600 font-medium"></p>
                    </div>
                </div>
                <div id="drugResult" class="hidden mt-4 p-4 rounded"></div>
                <div id="aiExplainBox"
                    class="hidden mt-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg text-sm text-blue-900">
                </div>
                <div id="aiMeter" class="glass-effect p-6 mt-6 hidden">
                    <h4 class="text-lg font-semibold mb-2">ü§ñ AI Risk Confidence</h4>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="riskBar" class="h-4 rounded-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                    <p id="confidenceText" class="mt-3 text-sm font-medium"></p>
                </div>
            </div>
        </section>

        <!-- AI Assistant Chat -->
        <section id="ai-assistant" class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">AI Pharmacy Assistant</h3>
            <div class="glass-effect rounded-lg p-6 max-w-3xl mx-auto">
                <div class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4" id="chatMessages"></div>
                <div class="flex space-x-2">
                    <input type="text" id="chatInput" placeholder="Ask me anything..."
                        class="flex-1 px-4 py-2 border rounded-lg">
                    <button onclick="sendMessage()" class="px-6 py-2 bg-purple-600 text-white rounded-lg">Send</button>
                </div>
            </div>
        </section>

        <!-- Automated Services -->
        <section class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Automated Patient Services</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-effect rounded-lg p-6 card-hover">
                    <i class="fas fa-bell text-3xl text-purple-600 mb-4"></i>
                    <h4 class="text-lg font-semibold mb-2">Smart Reminders</h4>
                    <p class="text-gray-600 text-sm">AI sends personalized medication reminders via SMS and app
                        notifications.</p>
                </div>
                <div class="glass-effect rounded-lg p-6 card-hover">
                    <i class="fas fa-credit-card text-3xl text-green-600 mb-4"></i>
                    <h4 class="text-lg font-semibold mb-2">AutoPay System</h4>
                    <p class="text-gray-600 text-sm">Secure automatic payment processing for recurring prescriptions.
                    </p>
                </div>
                <div class="glass-effect rounded-lg p-6 card-hover">
                    <i class="fas fa-truck text-3xl text-blue-600 mb-4"></i>
                    <h4 class="text-lg font-semibold mb-2">Home Delivery</h4>
                    <p class="text-gray-600 text-sm">Free same-day delivery for chronic care patients.</p>
                </div>
            </div>
        </section>

        <!-- Supplier Integration -->
        <section class="mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Supplier Integration</h3>
            <div class="glass-effect p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 border rounded hover:border-purple-500 cursor-pointer">
                        <i class="fas fa-building text-2xl text-gray-500 mb-2"></i>
                        <p class="text-xs">MedSupply Co.</p>
                    </div>
                    <div class="text-center p-4 border rounded hover:border-purple-500 cursor-pointer">
                        <i class="fas fa-building text-2xl text-gray-500 mb-2"></i>
                        <p class="text-xs">PharmaDist Inc.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 text-gray-300 py-8 text-center text-sm">
        <p>¬© 2025 PharmAI - Intelligent Pharmacy Management System</p>
    </footer>

    <!-- FAB -->
    <button onclick="openQuickOrder()"
        class="fixed bottom-6 right-6 w-14 h-14 bg-purple-600 text-white rounded-full shadow-lg z-40">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Modal -->
    <div id="quickOrderModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Quick Order</h3>
            <div class="space-y-4">
                <input type="text" id="quickPatient" placeholder="Patient Name" class="w-full px-4 py-2 border rounded">
                <select id="quickMed" class="w-full px-4 py-2 border rounded"></select>
                <input type="number" id="quickQty" placeholder="Quantity" class="w-full px-4 py-2 border rounded">
                <button onclick="submitQuickOrder()"
                    class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Submit</button>
                <button onclick="closeQuickOrder()" class="w-full text-gray-500">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let inventory = [];
        let billItems = [];

        async function init() {
            setupEventListenersOnce();
            await refreshData();
            initChart();
        }

        async function refreshData() {
            await Promise.all([fetchInventory(), fetchAnalytics(), fetchHistory(), fetchExpiryAlerts()]);
        }

        async function fetchExpiryAlerts() {
            try {
                const res = await fetch(`${API_URL}/expiry-alerts`);
                const alerts = await res.json();
                const list = document.getElementById("expiryAlertsList");
                if (alerts.length === 0) {
                    list.innerHTML = `<div class="p-3 bg-green-50 text-green-700 text-xs rounded border border-green-100"><i class="fas fa-check-circle mr-1"></i> All stock is clinically safe.</div>`;
                    return;
                }
                list.innerHTML = alerts.map(a => {
                    let color = a.status === "Warning" ? "yellow" : (a.status === "Critical" ? "orange" : "red");
                    return `<div class="bg-${color}-50 border-l-4 border-${color}-500 p-2 slide-in"><p class="font-bold text-[13px] text-${color}-900">${a.name}</p><p class="text-[11px] text-${color}-700">${a.status}: ${a.daysRemaining} days left</p></div>`;
                }).join('');
            } catch (error) { console.error(error); }
        }

        async function fetchInventory() {
            const res = await fetch(`${API_URL}/inventory`);
            inventory = await res.json();
            renderInventory();
            updateMedicineDropdowns();
        }

        function renderInventory() {
            const table = document.getElementById("inventoryTable");
            const lowStockList = document.getElementById("lowStockAlertsList");
            let lowStockHTML = "";
            table.innerHTML = inventory.map(med => {
                const exp = getExpiryStatus(med.expiry);
                if (med.stock < 20) {
                    lowStockHTML += `<div class="bg-red-50 border-l-4 border-red-500 p-2"><p class="font-bold text-[13px] text-red-900">${med.name}</p><p class="text-red-700 text-[11px]">Only ${med.stock} left</p><button onclick="alert('Refill requested')" class="text-[10px] underline">Order Now</button></div>`;
                }
                let badge = exp.status === "expired" ? "badge-risk" : (exp.status === "warning" ? "badge-warn" : "badge-safe");
                return `<tr class="border-b"><td class="py-3 px-2 font-medium">${med.name}</td><td class="text-center">${med.batch}</td><td class="text-center font-bold">${med.stock}</td><td class="text-center">${med.expiry}</td><td class="text-center"><span class="${badge} px-3 py-1 rounded text-xs uppercase font-semibold">${exp.label}</span></td></tr>`;
            }).join('');
            lowStockList.innerHTML = lowStockHTML || `<div class="text-xs text-green-700">Stock optimal</div>`;
        }

        function getExpiryStatus(expiry) {
            const diffDays = Math.ceil((new Date(expiry) - new Date()) / 86400000);
            if (diffDays < 0) return { status: "expired", label: "Expired" };
            if (diffDays <= 30) return { status: "warning", label: "Warning" };
            return { status: "safe", label: "Safe" };
        }

        function updateMedicineDropdowns() {
            const selects = ['billMedicineSelect', 'medicineSelect', 'quickMed'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">-- Select --</option>' + inventory.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
            });
        }

        function addToBill() {
            const name = document.getElementById('billMedicineSelect').value;
            const qty = parseInt(document.getElementById('billQty').value);
            const med = inventory.find(m => m.name === name);
            if (!med || !qty || qty > med.stock) return alert("Invalid drug/qty");
            billItems.push({ name, price: med.sellPrice, qty, total: med.sellPrice * qty });
            renderBill();
        }

        function renderBill() {
            const table = document.getElementById('billTable');
            table.innerHTML = billItems.map(i => `<tr class="border-b hover:bg-gray-50"><td class="p-2 font-medium">${i.name}</td><td class="text-center">‚Çπ${i.price}</td><td class="text-center font-bold">${i.qty}</td><td class="text-right font-bold text-purple-600">‚Çπ${i.total}</td></tr>`).join('');

            const sub = billItems.reduce((s, i) => s + i.total, 0);
            const gst = Math.round(sub * 0.05);

            const subTotalEl = document.getElementById('subTotal');
            const gstAmountEl = document.getElementById('gstAmount');
            const grandTotalEl = document.getElementById('grandTotal');

            if (subTotalEl) subTotalEl.innerText = sub;
            if (gstAmountEl) gstAmountEl.innerText = gst;
            if (grandTotalEl) grandTotalEl.innerText = sub + gst;
        }

        async function finalizeBill() {
            const patient = document.getElementById('billPatient').value;
            if (!patient || !billItems.length) return alert("Error");
            await fetch(`${API_URL}/sales`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ patient, items: billItems, totalAmount: parseInt(document.getElementById('grandTotal').innerText) }) });
            billItems = []; renderBill(); await refreshData();
        }

        async function fetchHistory() {
            const patient = document.getElementById("patientSelect").value.trim();
            const res = await fetch(`${API_URL}/patient-history${patient ? '?patient=' + encodeURIComponent(patient) : ''}`);
            const history = await res.json();
            document.getElementById("historyList").innerHTML = history.map(h => `<div class="p-3 bg-purple-50 rounded border-l-4 border-purple-500"><p class="font-bold">${h.patient}</p><p class="text-sm">${h.details}</p></div>`).join('');
        }

        async function fetchAnalytics() {
            const res = await fetch(`${API_URL}/analytics`);
            const data = await res.json();
            document.getElementById("todaySales").innerText = data.todayRevenue;
            document.getElementById("statOrdersDisplay").innerText = data.orderCount;
            document.getElementById("statPatientsDisplay").innerText = data.totalPatients;
        }

        async function checkDrugInteraction() {
            const drug1 = document.getElementById('drug1').value;
            const drug2 = document.getElementById('drug2').value;
            if (!drug1 || !drug2) return alert("Please enter both drugs to check clinical interaction.");

            try {
                const res = await fetch(`${API_URL}/check-interaction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drug1, drug2 })
                });
                const data = await res.json();

                const r = document.getElementById("drugResult");
                const bar = document.getElementById("riskBar");
                const text = document.getElementById("confidenceText");
                const explain = document.getElementById("aiExplainBox");
                const ameter = document.getElementById("aiMeter");

                r.classList.remove("hidden");
                explain.classList.remove("hidden");
                ameter.classList.remove("hidden");

                if (data.interaction) {
                    r.className = "mt-4 p-4 rounded-lg bg-red-50 text-red-900 border border-red-200 slide-in";
                    r.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                            <strong class="text-lg">${data.severity} Interaction Detected</strong>
                        </div>
                        <p class="text-sm mb-3">${data.message}</p>
                        <div class="bg-white p-3 rounded border border-red-100 text-xs">
                            <p class="mb-2"><strong>Potentially Life-Threatening Effects:</strong><br><span class="text-red-600 font-semibold">${data.effects || 'N/A'}</span></p>
                            <p class="mb-2"><strong>Pharmacological Mechanism:</strong><br>${data.mechanism || 'N/A'}</p>
                            <p class="text-red-700 font-bold"><strong>Clinical Recommendation:</strong><br>${data.recommendation || 'N/A'}</p>
                        </div>
                    `;
                    bar.style.width = data.severity === "Major" ? "95%" : "60%";
                    bar.style.background = "#dc2626";
                    text.innerText = `High Clinical Confidence (~${bar.style.width})`;
                    explain.innerHTML = `<i class="fas fa-microscope mr-2"></i> PharmAI Clinical Insight: Cross-validated with standard pharmacopoeia indices.`;
                } else {
                    r.className = "mt-4 p-4 rounded-lg bg-green-50 text-green-900 border border-green-200 slide-in";
                    r.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-check-circle text-green-600"></i>
                            <strong class="text-lg">Low Clinical Risk</strong>
                        </div>
                        <p class="text-sm">${data.message}</p>
                    `;
                    bar.style.width = "15%";
                    bar.style.background = "#16a34a";
                    text.innerText = "Low AI confidence (~15%) for interaction";
                    explain.innerHTML = `<i class="fas fa-info-circle mr-2"></i> No major contraindications identified in current active database.`;
                }
            } catch (error) {
                console.error("Interaction check error:", error);
                alert("Could not complete clinical interaction check.");
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value;
            appendMessage('user', message);
            input.value = '';
            const res = await fetch(`${API_URL}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message }) });
            const data = await res.json();
            appendMessage('bot', data.reply);
        }

        function appendMessage(sender, text) {
            const msgContainer = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `mb-4 ${sender === 'user' ? 'text-right' : ''}`;
            if (sender === 'user') {
                div.innerHTML = `<span class="inline-block px-4 py-2 rounded-xl bg-purple-600 text-white text-sm shadow-sm">${text}</span>`;
            } else {
                div.innerHTML = `<span class="inline-block px-4 py-2 rounded-xl bg-white border text-gray-700 text-sm shadow-sm border-gray-100">${text}</span>`;
            }
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // Global UI Functions
        function filterOrders(status) {
            alert(`Filtering orders for: ${status}`);
            // Logic can be added here if orders API supports filtering
        }

        function trackOrder(id) {
            alert(`Tracking Order ${id}... (Feature Coming Soon)`);
        }

        function verifyPrescription() {
            const res = document.getElementById('verificationResult');
            res.classList.remove('hidden');
            res.innerHTML = '<div class="bg-blue-50 border border-blue-200 p-4 rounded text-blue-800 animate-pulse flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> PharmAI is verifying clinical signatures...</div>';
            setTimeout(() => {
                res.innerHTML = '<div class="bg-green-50 border border-green-200 p-4 rounded-lg text-green-800 flex items-center gap-2 slide-in"><i class="fas fa-check-circle"></i> Prescription Verified & Authenticated by AI</div>';
            }, 2000);
        }

        async function submitQuickOrder() {
            const patient = document.getElementById('quickPatient').value;
            const med = document.getElementById('quickMed').value;
            const qty = parseInt(document.getElementById('quickQty').value);
            if (!patient || !med || !qty) return alert("Fill all details");

            const medData = inventory.find(m => m.name === med);
            if (!medData) return alert("Medicine not found");

            const res = await fetch(`${API_URL}/sales`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient,
                    items: [{ name: med, qty, price: medData.sellPrice, total: medData.sellPrice * qty }],
                    totalAmount: Math.round((medData.sellPrice * qty) * 1.05)
                })
            });
            if (res.ok) {
                alert("Quick Order Placed Successfully!");
                closeQuickOrder();
                await refreshData();
            }
        }

        function setupEventListenersOnce() {
            // Medicine Detail Listener
            const medSelect = document.getElementById('medicineSelect');
            if (medSelect && !medSelect.dataset.listenerAttached) {
                medSelect.addEventListener('change', function () {
                    const medName = this.value;
                    const panel = document.getElementById('medicinePanel');
                    if (!medName) {
                        if (panel) panel.classList.add('hidden');
                        return;
                    }
                    const med = inventory.find(m => m.name === medName);
                    if (med && panel) {
                        panel.classList.remove('hidden');
                        document.getElementById('medPurpose').innerHTML = `<strong>Purpose:</strong> Used for managing ${med.category || 'general'} health conditions.`;
                        document.getElementById('medUsage').innerHTML = `<strong>Usage:</strong> Standard dosage as prescribed by physician. Current Stock: ${med.stock}`;
                        document.getElementById('medWarning').innerHTML = `<strong>Warning:</strong> Keep out of reach of children. Expiry: ${med.expiry}`;
                    }
                });
                medSelect.dataset.listenerAttached = "true";
            }

            const chatInput = document.getElementById('chatInput');
            if (chatInput && !chatInput.dataset.listenerAttached) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
                chatInput.dataset.listenerAttached = "true";
            }
        }

        function initChart() {
            const ctx = document.getElementById("stockChart").getContext("2d");
            new Chart(ctx, { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar'], datasets: [{ label: 'Stock', data: [100, 150, 130], borderColor: '#667eea' }] } });
        }

        function toggleMobileMenu() { document.getElementById('mobileMenu').classList.toggle('hidden'); }
        function openQuickOrder() { document.getElementById('quickOrderModal').classList.remove('hidden'); }
        function closeQuickOrder() { document.getElementById('quickOrderModal').classList.add('hidden'); }

        init();
    </script>
</body>

</html>